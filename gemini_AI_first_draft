I would like to use gatk4 to do variant calling on some whole genome illumina
sequencing reads, but I'm overwhelmed by the number of options and potential
cleanup steps. What are the most common steps and options used for a basic
variant calling process with gatk4?

Of course. It's easy to get overwhelmed, but the core GATK4 "Best Practices"
workflow for germline variant calling (SNPs and indels) is very logical. It's
broken down into two main phases: **Data Pre-processing** and
**Variant Calling**.

Here are the most common steps and the basic GATK commands for each.

-----

### Phase 1: Data Pre-processing (FASTQ to Analysis-Ready BAM)

The goal here is to turn your raw `.fastq` files from the sequencer into a clean, calibrated `.bam` file that is ready for variant calling.

#### Step 0: Alignment (Not a GATK tool, but required)

First, you must align your FASTQ reads to a reference genome. The most common tool for this is **BWA-MEM**. The output is a `.sam` file, which is then converted to a sorted `.bam` file.

  * **Key GATK requirement:** You **must** add a **Read Group** (`@RG`) header line during this step. GATK tools rely on this information.
  * **Example (combined alignment and sorting):**
    ```bash
    # Variables for clarity
    REF_GENOME="reference.fasta"
    READ1="sample1_R1.fastq.gz"
    READ2="sample1_R2.fastq.gz"
    OUTPUT_BAM="sample1.sorted.bam"

    # The -R option adds the read group. Adjust SM (Sample) and LB (Library) accordingly.
    # We pipe (|) the output of bwa mem directly to samtools sort to save space and time.
    bwa mem -t 4 -R "@RG\tID:group1\tSM:sample1\tPL:ILLUMINA\tLB:lib1" $REF_GENOME $READ1 $READ2 | \
    samtools sort -@ 4 -o $OUTPUT_BAM

    # Don't forget to index the BAM file
    samtools index $OUTPUT_BAM
    ```

#### Step 1: Mark Duplicate Reads

This step finds and flags PCR and optical duplicates that arise during sequencing. GATK's `HaplotypeCaller` ignores these flagged reads, which prevents over-counting evidence for a variant. This tool was part of Picard but is now included in GATK.

  * **Tool:** `gatk MarkDuplicates`
  * **Basic Command:**
    ```bash
    gatk MarkDuplicates \
      -I sample1.sorted.bam \
      -O sample1.marked_dups.bam \
      -M sample1.dup_metrics.txt

    # Index the new BAM file
    samtools index sample1.marked_dups.bam
    ```

#### Step 2: Base Quality Score Recalibration (BQSR)

This is a two-step machine learning process to correct systematic errors in the base quality scores reported by the sequencer.

**A. Build the Recalibration Model**
This step scans the reads and compares them to a database of known polymorphic sites (like dbSNP) to build a model of errors.

  * **Tool:** `gatk BaseRecalibrator`
  * **Required files:** You need your marked-duplicate BAM, the reference genome, and a VCF file of **known variant sites** (e.g., from dbSNP).
  * **Basic Command:**
    ```bash
    gatk BaseRecalibrator \
      -I sample1.marked_dups.bam \
      -R reference.fasta \
      --known-sites known_sites.vcf.gz \
      -O sample1.recal_data.table
    ```

**B. Apply the Recalibration**
This step uses the model built in part A to adjust the quality scores for every base in your BAM file.

  * **Tool:** `gatk ApplyBQSR`
  * **Basic Command:**
    ```bash
    gatk ApplyBQSR \
      -I sample1.marked_dups.bam \
      -R reference.fasta \
      --bqsr-recal-file sample1.recal_data.table \
      -O sample1.analysis_ready.bam

    # Index your final, analysis-ready BAM file
    samtools index sample1.analysis_ready.bam
    ```

**Your file `sample1.analysis_ready.bam` is now ready for variant calling.**

-----

### Phase 2: Variant Calling (BAM to VCF)

The goal of this phase is to identify variant sites and genotype them. The best-practice method is "joint calling," where you process samples individually first and then combine them for final genotyping.

#### Step 3: Call Variants Per-Sample

Run `HaplotypeCaller` on each of your analysis-ready BAM files **one by one**. The key is to run it in `-ERC GVCF` mode, which produces a "genomic VCF" (`.g.vcf`). This file contains variant information *and* blocks of data about non-variant sites.

  * **Tool:** `gatk HaplotypeCaller`
  * **Basic Command:**
    ```bash
    gatk HaplotypeCaller \
      -I sample1.analysis_ready.bam \
      -R reference.fasta \
      -ERC GVCF \
      -O sample1.g.vcf.gz

    # --- Repeat for other samples ---
    # gatk HaplotypeCaller -I sample2.analysis_ready.bam ... -O sample2.g.vcf.gz
    # gatk HaplotypeCaller -I sample3.analysis_ready.bam ... -O sample3.g.vcf.gz
    ```

#### Step 4: Consolidate gVCFs

This step efficiently combines the gVCFs from all your individual samples into a single database. This is much faster than trying to combine many VCFs at once.

  * **Tool:** `gatk GenomicsDBImport`
  * **Note:** This tool works on intervals. For a basic run, you can specify your main chromosomes (e.g., `-L chr1 -L chr2`). For whole-genome data, it's often run per chromosome or chromosome group.
  * **Basic Command (for a few samples):**
    ```bash
    gatk GenomicsDBImport \
      --genomicsdb-workspace-path my_database \
      -L chr1 \
      -V sample1.g.vcf.gz \
      -V sample2.g.vcf.gz \
      -V sample3.g.vcf.gz
    ```

#### Step 5: Joint Genotyping

This is the final step. It takes the combined database from `GenomicsDBImport` and runs the genotyping algorithm across all samples simultaneously. This "joint" analysis uses information from all samples to make more accurate calls for each one.

  * **Tool:** `gatk GenotypeGVCFs`
  * **Basic Command:**
    ```bash
    gatk GenotypeGVCFs \
      -R reference.fasta \
      -V gendb://my_database \
      -O cohort.vcf.gz
    ```

You will now have a single file, **`cohort.vcf.gz`**, containing the variants for your entire set of samples. The next step, which is more advanced, would be to filter this VCF using `VariantRecalibrator` (VQSR), but the steps above will give you a complete, un-filtered callset.

Would you like me to elaborate on any of these steps, such as where to find the "known sites" files or what VQSR filtering does?